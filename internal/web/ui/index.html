<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoH AutoProxy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sidebar-link { position: relative; display: flex; align-items: center; padding: 0.75rem 1.5rem; color: #9ca3af; transition: all 0.2s; font-weight: 500; }
        .sidebar-link:hover { color: #f3f4f6; background-color: rgba(255,255,255,0.05); }
        .sidebar-link.active { color: #10b981; background-color: rgba(16, 185, 129, 0.1); border-right: 3px solid #10b981; }
        .sidebar-link i { width: 1.5rem; text-align: center; margin-right: 0.75rem; }
        
        .toggle-checkbox { appearance: none; background: #fff; border-width: 0; width: 1.25rem; height: 1.25rem; border-radius: 50%; position: absolute; top: 0.125rem; left: 0.125rem; transition: transform 0.3s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .toggle-track { width: 2.75rem; height: 1.5rem; background: #e5e7eb; border-radius: 999px; position: relative; transition: background 0.3s ease; cursor: pointer; }
        .toggle-input:checked + .toggle-track { background: #10b981; }
        .toggle-input:checked + .toggle-track .toggle-checkbox { transform: translateX(1.25rem); }
        
        .table-container { max-height: calc(100vh - 240px); overflow-y: auto; scrollbar-width: thin; }
        .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        thead th { position: sticky; top: 0; z-index: 10; background: #f8fafc; }
        
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

        .sort-icon { display: inline-block; margin-left: 4px; font-size: 0.75rem; color: #9ca3af; cursor: pointer; }
        .sort-icon:hover { color: #4b5563; }
        .sort-icon.active { color: #10b981; }
    </style>
</head>
<body>
<div id="app" class="flex h-screen overflow-hidden text-gray-900">
    <aside class="w-64 bg-slate-900 flex flex-col flex-shrink-0 shadow-xl z-20">
        <div class="h-16 flex items-center px-6 bg-slate-950 border-b border-slate-800">
            <div class="text-green-500 text-2xl mr-2"><i class="fa-solid fa-shield-cat"></i></div>
            <h1 class="text-xl font-bold tracking-wide text-white">AutoProxy</h1>
        </div>
        
        <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
            <a href="#" @click.prevent="currentView = 'dashboard'" :class="{'active': currentView === 'dashboard'}" class="sidebar-link">
                <i class="fa-solid fa-chart-pie"></i>
                <span>{{ t('menu_dashboard') }}</span>
            </a>
            <a href="#" @click.prevent="currentView = 'logs'" :class="{'active': currentView === 'logs'}" class="sidebar-link">
                <i class="fa-solid fa-list-check"></i>
                <span>{{ t('menu_logs') }}</span>
            </a>
            <a href="#" @click.prevent="currentView = 'settings'" :class="{'active': currentView === 'settings'}" class="sidebar-link">
                <i class="fa-solid fa-sliders"></i>
                <span>{{ t('menu_settings') }}</span>
            </a>
        </nav>

        <div class="p-4 border-t border-slate-800 bg-slate-950">
            <div class="flex items-center justify-between">
                <span class="text-xs text-slate-500 font-mono">v1.4.0</span>
                <button @click="toggleLang" class="text-xs font-bold text-slate-400 hover:text-white border border-slate-700 rounded px-2 py-1 transition-colors uppercase tracking-wider">{{ lang }}</button>
            </div>
        </div>
    </aside>

    <div class="flex-1 flex flex-col min-w-0 bg-gray-50">
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-8 z-10">
            <h2 class="text-xl font-bold text-gray-800">{{ t('menu_' + currentView) }}</h2>
            <div class="flex items-center space-x-6">
                <div class="flex items-center px-3 py-1 bg-green-50 rounded-full border border-green-100">
                    <span class="relative flex h-2 w-2 mr-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span class="text-sm font-medium text-green-700">{{ t('status_running') }}</span>
                </div>
                
                <button v-if="authEnabled && !isLoggedIn" @click="openLogin" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-sm text-sm font-medium transition-all flex items-center">
                    <i class="fa-solid fa-right-to-bracket mr-2"></i> {{ t('login') }}
                </button>
                <button v-if="authEnabled && isLoggedIn" @click="doLogout" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-sm text-sm font-medium transition-all flex items-center">
                    <i class="fa-solid fa-right-from-bracket mr-2"></i> {{ t('logout') }}
                </button>

                <button v-if="currentView === 'settings' && (!authEnabled || isLoggedIn)" @click="saveConfig" :disabled="loading" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg shadow-sm text-sm font-medium transition-all flex items-center disabled:opacity-50">
                    <i class="fa-solid fa-save mr-2"></i> {{ loading ? t('saving') : t('save_apply') }}
                </button>
                
                <button v-if="currentView === 'logs'" @click="fetchLogs" class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-4 py-2 rounded-lg shadow-sm text-sm font-medium transition-all flex items-center">
                    <i class="fa-solid fa-rotate mr-2"></i> {{ t('refresh') }}
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-8">
            
            <div v-if="currentView === 'dashboard'" class="space-y-8 animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-100 relative overflow-hidden">
                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 rounded-full bg-blue-50 opacity-50"></div>
                        <div class="relative z-10">
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">{{ t('stats_total_queries') }}</p>
                            <div class="flex items-end">
                                <h3 class="text-3xl font-bold text-gray-900">{{ formatNumber(stats.total_queries) }}</h3>
                            </div>
                        </div>
                        <div class="absolute bottom-4 right-4 text-blue-500 text-2xl opacity-20"><i class="fa-solid fa-database"></i></div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-100 relative overflow-hidden">
                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 rounded-full bg-purple-50 opacity-50"></div>
                        <div class="relative z-10">
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">{{ t('stats_memory') }}</p>
                            <div class="flex items-end">
                                <h3 class="text-3xl font-bold text-gray-900">{{ stats.memory_usage_mb?.toFixed(1) }} <span class="text-lg font-medium text-gray-500">MB</span></h3>
                            </div>
                            <p class="text-xs text-gray-400 mt-2 font-mono">{{ stats.num_goroutines }} Goroutines</p>
                        </div>
                        <div class="absolute bottom-4 right-4 text-purple-500 text-2xl opacity-20"><i class="fa-solid fa-microchip"></i></div>
                    </div>

                    <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-100 relative overflow-hidden">
                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 rounded-full bg-green-50 opacity-50"></div>
                        <div class="relative z-10">
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">{{ t('stats_uptime') }}</p>
                            <h3 class="text-2xl font-bold text-gray-900">{{ formatUptime(stats.uptime_seconds) }}</h3>
                        </div>
                        <div class="absolute bottom-4 right-4 text-green-500 text-2xl opacity-20"><i class="fa-solid fa-stopwatch"></i></div>
                    </div>

                    <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-100 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 rounded-full bg-orange-50 opacity-50"></div>
                        <div class="relative z-10">
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">{{ t('stats_ports') }}</p>
                            <div class="space-y-1">
                                <div class="flex justify-between text-sm" v-if="stats.listen_dns_udp"><span class="text-gray-500">UDP:</span> <span class="font-mono font-medium">{{ stats.listen_dns_udp }}</span></div>
                                <div class="flex justify-between text-sm" v-if="stats.listen_dns_tcp"><span class="text-gray-500">TCP:</span> <span class="font-mono font-medium">{{ stats.listen_dns_tcp }}</span></div>
                                <div class="flex justify-between text-sm" v-if="stats.listen_doh"><span class="text-gray-500">DoH:</span> <span class="font-mono font-medium">{{ stats.listen_doh }}</span></div>
                                <div class="flex justify-between text-sm" v-if="stats.listen_dot"><span class="text-gray-500">DoT:</span> <span class="font-mono font-medium">{{ stats.listen_dot }}</span></div>
                                <div class="flex justify-between text-sm" v-if="stats.listen_doq"><span class="text-gray-500">DoQ:</span> <span class="font-mono font-medium">{{ stats.listen_doq }}</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center"><i class="fa-solid fa-chart-pie mr-2 text-indigo-500"></i> {{ t('stats_traffic_distribution') }}</h3>
                        <div class="space-y-6">
                            <div>
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="font-medium text-gray-700 flex items-center"><span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> CN (Domestic)</span>
                                    <span class="font-bold text-gray-900">{{ stats.total_cn }}</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                    <div class="bg-green-500 h-3 rounded-full transition-all duration-500" :style="{width: getPercentage(stats.total_cn, stats.total_queries) + '%'}"></div>
                                </div>
                                <div class="text-right text-xs text-gray-500 mt-1">{{ getPercentage(stats.total_cn, stats.total_queries) }}%</div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="font-medium text-gray-700 flex items-center"><span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span> Overseas</span>
                                    <span class="font-bold text-gray-900">{{ stats.total_overseas }}</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                    <div class="bg-blue-500 h-3 rounded-full transition-all duration-500" :style="{width: getPercentage(stats.total_overseas, stats.total_queries) + '%'}"></div>
                                </div>
                                <div class="text-right text-xs text-gray-500 mt-1">{{ getPercentage(stats.total_overseas, stats.total_queries) }}%</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:col-span-2 flex flex-col">
                         <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-server mr-2 text-indigo-500"></i> {{ t('stats_upstream_perf') }}</h3>
                         
                         <div class="overflow-auto flex-1 max-h-96 pr-2 custom-scrollbar">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50 text-gray-500 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="py-2 px-3 text-left font-medium">{{ t('table_server') }}</th>
                                        <th class="py-2 px-3 text-left font-medium">{{ t('table_group') }}</th>
                                        <th class="py-2 px-3 text-right font-medium">{{ t('table_queries') }}</th>
                                        <th class="py-2 px-3 text-right font-medium">{{ t('table_errors') }}</th>
                                        <th class="py-2 px-3 text-right font-medium">{{ t('table_canceled') }}</th>
                                        <th class="py-2 px-3 text-right font-medium">{{ t('table_avg_time') }}</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <tr v-for="s in stats.upstream_stats" :key="s.address" class="hover:bg-gray-50 transition-colors">
                                        <td class="py-2 px-3 font-mono text-xs text-gray-600 truncate max-w-[150px]" :title="s.address">{{ s.address }} <span class="text-[10px] text-gray-400 ml-1">{{ s.protocol }}</span></td>
                                        <td class="py-2 px-3">
                                            <span class="px-2 py-0.5 rounded text-xs font-medium" :class="s.group === 'CN' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'">{{ s.group }}</span>
                                        </td>
                                        <td class="py-2 px-3 text-right font-mono">{{ s.total_queries }}</td>
                                        <td class="py-2 px-3 text-right font-mono text-red-500 font-medium">{{ s.total_errors > 0 ? s.total_errors : '-' }}</td>
                                        <td class="py-2 px-3 text-right font-mono text-gray-400">{{ s.total_canceled > 0 ? s.total_canceled : '-' }}</td>
                                        <td class="py-2 px-3 text-right font-mono font-medium" :class="getLatencyClass(s.avg_duration_ms)">{{ s.avg_duration_ms }} ms</td>
                                    </tr>
                                    <tr v-if="!stats.upstream_stats || stats.upstream_stats.length === 0">
                                        <td colspan="6" class="py-8 text-center text-gray-400 italic">No upstream data available yet...</td>
                                    </tr>
                                </tbody>
                            </table>
                         </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" v-if="sortedTopClients.length > 0">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-users mr-2 text-indigo-500"></i> {{ t('top_clients') }}</h3>
                        <ul class="space-y-3">
                            <li v-for="(client, idx) in sortedTopClients.slice(0, 5)" :key="client[0]" class="flex justify-between items-center text-sm p-2 hover:bg-gray-50 rounded transition-colors">
                                <div class="flex items-center overflow-hidden">
                                    <span class="text-gray-400 font-mono mr-3 w-4 text-right">{{ idx + 1 }}</span>
                                    <span class="text-gray-700 font-medium truncate" :title="client[0]">{{ client[0] }}</span>
                                </div>
                                <span class="font-mono font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded text-xs">{{ client[1] }}</span>
                            </li>
                        </ul>
                     </div>
                     
                     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" v-if="sortedTopDomains.length > 0">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-globe mr-2 text-indigo-500"></i> {{ t('top_domains') }}</h3>
                        <ul class="space-y-3">
                            <li v-for="(domain, idx) in sortedTopDomains.slice(0, 5)" :key="domain[0]" class="flex justify-between items-center text-sm p-2 hover:bg-gray-50 rounded transition-colors">
                                <div class="flex items-center overflow-hidden">
                                    <span class="text-gray-400 font-mono mr-3 w-4 text-right">{{ idx + 1 }}</span>
                                    <span class="text-gray-700 font-medium truncate" :title="domain[0]">{{ domain[0] }}</span>
                                </div>
                                <span class="font-mono font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded text-xs">{{ domain[1] }}</span>
                            </li>
                        </ul>
                     </div>
                </div>
            </div>

            <div v-if="currentView === 'logs'" class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col h-full overflow-hidden animate-fade-in">
                <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                    <div class="flex items-center gap-2 text-gray-700">
                         <i class="fa-solid fa-list-ul"></i> <span class="font-medium">{{ t('logs_title') }}</span>
                    </div>
                    <div class="flex gap-2 w-full max-w-md">
                        <div class="relative flex-1">
                            <input v-model="logsFilter" :placeholder="t('filter_logs_placeholder')" @keyup.enter="fetchLogs" class="w-full border border-gray-300 rounded-lg pl-9 pr-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all">
                            <i class="fa-solid fa-search absolute left-3 top-2 text-gray-400 text-xs"></i>
                        </div>
                        <button @click="fetchLogs" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm shadow-sm transition-colors">{{ t('search') }}</button>
                    </div>
                </div>
                <div class="flex-1 table-container">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50 sticky top-0 z-20 shadow-sm">
                            <tr>
                                <th @click="sortBy('time')" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:text-gray-700 group">
                                    {{ t('log_time') }} <i class="sort-icon fa-solid" :class="getSortIcon('time')"></i>
                                </th>
                                <th @click="sortBy('client_ip')" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:text-gray-700 group">
                                    {{ t('log_client') }} <i class="sort-icon fa-solid" :class="getSortIcon('client_ip')"></i>
                                </th>
                                <th @click="sortBy('domain')" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:text-gray-700 group">
                                    {{ t('log_domain') }} <i class="sort-icon fa-solid" :class="getSortIcon('domain')"></i>
                                </th>
                                <th @click="sortBy('type')" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:text-gray-700 group">
                                    {{ t('log_type') }} <i class="sort-icon fa-solid" :class="getSortIcon('type')"></i>
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                    {{ t('log_answer') }}
                                </th>
                                <th @click="sortBy('upstream')" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:text-gray-700 group">
                                    {{ t('log_upstream') }} <i class="sort-icon fa-solid" :class="getSortIcon('upstream')"></i>
                                </th>
                                <th @click="sortBy('status')" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:text-gray-700 group">
                                    {{ t('log_status') }} <i class="sort-icon fa-solid" :class="getSortIcon('status')"></i>
                                </th>
                                <th @click="sortBy('duration_ms')" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:text-gray-700 group">
                                    {{ t('log_duration') }} <i class="sort-icon fa-solid" :class="getSortIcon('duration_ms')"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            <tr v-for="log in sortedLogs" :key="log.id" class="hover:bg-blue-50 transition-colors">
                                <td class="px-4 py-2 whitespace-nowrap text-gray-500 font-mono text-xs">{{ formatTime(log.time) }}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-indigo-600 cursor-pointer hover:underline font-medium" @click="logsFilter = log.client_ip; fetchLogs()">{{ log.client_ip }}</td>
                                <td class="px-4 py-2 text-gray-900 font-medium break-all">{{ log.domain }}</td>
                                <td class="px-4 py-2 text-gray-500 text-xs">{{ log.type }}</td>
                                <td class="px-4 py-2 text-gray-600 font-mono text-xs truncate max-w-[200px]" :title="log.answer">{{ log.answer }}</td>
                                <td class="px-4 py-2 whitespace-nowrap">
                                    <span class="px-2 py-0.5 inline-flex text-xs leading-4 font-medium rounded-full" :class="getUpstreamClass(log.upstream)">
                                        {{ log.upstream }}
                                    </span>
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap">
                                    <span class="px-2 py-0.5 rounded text-xs font-bold" :class="log.status === 'NOERROR' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">{{ log.status }}</span>
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap text-gray-500 font-mono text-xs">{{ log.duration_ms }}ms</td>
                            </tr>
                            <tr v-if="logs.length === 0">
                                <td colspan="8" class="px-4 py-12 text-center text-gray-400">
                                    <i class="fa-solid fa-inbox text-4xl mb-3 opacity-30"></i>
                                    <p>{{ t('no_logs') }}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="currentView === 'settings'" class="space-y-8 max-w-5xl mx-auto pb-10 animate-fade-in">
            
                 <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center">
                        <i class="fa-solid fa-database text-gray-400 mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">{{ t('setting_querylog') }}</h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-gray-50 rounded-lg border border-gray-100">
                            <div class="flex flex-col space-y-4">
                                <toggle-switch :label="t('setting_save_file')" v-model="config.query_log.save_to_file" :disabled="!canEdit"></toggle-switch>
                                <div v-if="config.query_log.save_to_file">
                                     <form-input :label="t('setting_log_path')" v-model="config.query_log.file" placeholder="query.log" class="transition-all" :disabled="!canEdit"></form-input>
                                     <p class="text-xs text-gray-500 mt-1">Defaults to 'query.log' if empty.</p>
                                </div>
                            </div>
                            <form-input :label="t('setting_log_limit')" v-model.number="config.query_log.max_history" type="number" :disabled="!canEdit"></form-input>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center">
                        <i class="fa-solid fa-network-wired text-gray-400 mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">{{ t('setting_listen') }}</h3>
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <form-input :label="t('dns_udp')" v-model="config.listen.dns_udp" placeholder=":53" :disabled="!canEdit"></form-input>
                        <form-input :label="t('dns_tcp')" v-model="config.listen.dns_tcp" placeholder=":53" :disabled="!canEdit"></form-input>
                        <form-input :label="t('doh_https')" v-model="config.listen.doh" placeholder=":443" :disabled="!canEdit"></form-input>
                        <form-input :label="t('dot_tls')" v-model="config.listen.dot" placeholder=":853" :disabled="!canEdit"></form-input>
                        <form-input :label="t('doq_quic')" v-model="config.listen.doq" placeholder=":853" :disabled="!canEdit"></form-input>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center">
                        <i class="fa-solid fa-rocket text-gray-400 mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">{{ t('setting_bootstrap') }}</h3>
                    </div>
                    <div class="p-6">
                        <div v-for="(dns, index) in config.bootstrap_dns" :key="index" class="flex mb-3 items-center">
                            <div class="flex-1">
                                <input type="text" v-model="config.bootstrap_dns[index]" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2.5 border transition-shadow disabled:bg-gray-100 disabled:text-gray-500" placeholder="8.8.8.8:53" :disabled="!canEdit">
                            </div>
                            <button v-if="canEdit" @click="removeBootstrap(index)" class="ml-3 text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition-colors"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <button v-if="canEdit" @click="addBootstrap" class="mt-2 flex items-center text-sm text-indigo-600 hover:text-indigo-800 font-medium px-3 py-2 rounded hover:bg-indigo-50 transition-colors"><i class="fa-solid fa-plus mr-1"></i> {{ t('add') }}</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <div class="flex items-center">
                            <i class="fa-solid fa-server text-gray-400 mr-3"></i>
                            <h3 class="text-lg font-medium text-gray-900">{{ t('setting_upstreams') }}</h3>
                        </div>
                        <button @click="testUpstreams" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded-lg shadow-sm text-sm font-medium transition-all flex items-center">
                            <i class="fa-solid fa-vial mr-2"></i> {{ t('test_upstreams') }}
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg mb-6 w-fit">
                            <button @click="upstreamTab = 'cn'" class="px-4 py-2 rounded-md text-sm font-medium transition-all" :class="upstreamTab === 'cn' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'">{{ t('tab_cn') }}</button>
                            <button @click="upstreamTab = 'overseas'" class="px-4 py-2 rounded-md text-sm font-medium transition-all" :class="upstreamTab === 'overseas' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'">{{ t('tab_overseas') }}</button>
                        </div>

                        <div class="space-y-4">
                            <div v-for="(server, index) in currentUpstreams" :key="index" class="bg-gray-50 rounded-xl p-5 border border-gray-200 relative group hover:border-indigo-300 transition-colors">
                                <button v-if="canEdit" @click="removeUpstream(upstreamTab, index)" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-white shadow-sm opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash-can"></i></button>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                    <form-input :label="t('address')" v-model="server.address" placeholder="1.1.1.1:53" :disabled="!canEdit"></form-input>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('protocol') }}</label>
                                        <select :disabled="!canEdit" v-model="server.protocol" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border shadow-sm bg-white disabled:bg-gray-100 disabled:text-gray-500">
                                            <option value="udp">UDP</option>
                                            <option value="tcp">TCP</option>
                                            <option value="doh">DoH</option>
                                            <option value="dot">DoT</option>
                                            <option value="doq">DoQ</option>
                                        </select>
                                    </div>
                                    <form-input :label="t('ecs_ip')" v-model="server.ecs_ip" placeholder="Client Subnet IP" :disabled="!canEdit"></form-input>
                                </div>
                                <div class="mt-4 flex flex-wrap gap-6 pt-4 border-t border-gray-200">
                                    <toggle-switch v-if="showPipeline(server.protocol)" label="Pipeline" v-model="server.pipeline" :disabled="!canEdit"></toggle-switch>
                                    <toggle-switch v-if="showH3(server.protocol)" label="HTTP/3" v-model="server.http3" :disabled="!canEdit"></toggle-switch>
                                    <toggle-switch v-if="showVerify(server.protocol)" label="Skip Verify" v-model="server.insecure_skip_verify" :disabled="!canEdit"></toggle-switch>
                                </div>
                            </div>
                            <button v-if="canEdit" @click="addUpstream(upstreamTab)" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-indigo-500 hover:text-indigo-500 hover:bg-indigo-50 transition-all font-medium flex items-center justify-center"><i class="fa-solid fa-plus-circle mr-2"></i> {{ t('add_server') }}</button>
                        </div>
                    </div>
                </div>

                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center">
                            <i class="fa-solid fa-earth-asia text-gray-400 mr-3"></i>
                            <h3 class="text-lg font-medium text-gray-900">Geo Data</h3>
                        </div>
                        <div class="p-6 space-y-5">
                            <form-input label="GeoIP File" v-model="config.geo_data.geoip_dat" :disabled="!canEdit"></form-input>
                            <form-input label="GeoSite File" v-model="config.geo_data.geosite_dat" :disabled="!canEdit"></form-input>
                            <form-input label="GeoIP URL" v-model="config.geo_data.geoip_download_url" class="text-sm" :disabled="!canEdit"></form-input>
                            <form-input label="GeoSite URL" v-model="config.geo_data.geosite_download_url" class="text-sm" :disabled="!canEdit"></form-input>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center">
                            <i class="fa-solid fa-certificate text-gray-400 mr-3"></i>
                            <h3 class="text-lg font-medium text-gray-900">Auto Certificate (ACME)</h3>
                        </div>
                        <div class="p-6 space-y-5">
                            <toggle-switch label="Enable AutoCert" v-model="config.auto_cert.enabled" :disabled="!canEdit"></toggle-switch>
                            <template v-if="config.auto_cert.enabled">
                                <form-input label="Email" v-model="config.auto_cert.email" :disabled="!canEdit"></form-input>
                                <div class="mb-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Domains</label>
                                    <div v-for="(d, i) in config.auto_cert.domains" :key="i" class="flex mb-2">
                                        <input v-model="config.auto_cert.domains[i]" class="flex-1 rounded-lg border-gray-300 p-2.5 text-sm border shadow-sm" placeholder="example.com" :disabled="!canEdit">
                                        <button v-if="canEdit" @click="config.auto_cert.domains.splice(i, 1)" class="ml-2 text-red-400 hover:text-red-600 w-8 flex justify-center items-center"><i class="fa-solid fa-times"></i></button>
                                    </div>
                                    <button v-if="canEdit" @click="config.auto_cert.domains.push('')" class="mt-1 text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center"><i class="fa-solid fa-plus mr-1"></i> Add Domain</button>
                                </div>
                                <form-input label="Cert Storage Dir" v-model="config.auto_cert.cert_dir" :disabled="!canEdit"></form-input>
                            </template>
                        </div>
                    </div>
                 </div>
            </div>
        </main>
        
        <modal :show="modal.show" :title="modal.title" @close="modal.show = false">
            <div v-if="modal.type === 'saving'" class="flex flex-col items-center justify-center py-4">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-indigo-500 mb-4"></i>
                <p class="text-gray-600">{{ t('saving') }}</p>
            </div>
            
            <div v-if="modal.type === 'saved'" class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fa-solid fa-check text-green-600 text-xl"></i>
                </div>
                <p class="text-sm text-gray-500">{{ t('saved_msg') }}</p>
            </div>
            
            <div v-if="modal.type === 'testing'" class="flex flex-col items-center justify-center py-4">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-600">{{ t('testing') }}</p>
            </div>
            
            <div v-if="modal.type === 'test'" class="max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Address</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Group</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Status</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Latency</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="(res, i) in modal.testResults" :key="i">
                            <td class="px-3 py-2 truncate max-w-[150px]" :title="res.address">{{ res.address }}</td>
                            <td class="px-3 py-2">{{ res.group }}</td>
                            <td class="px-3 py-2 text-right" :class="getTestStatusClass(res.status)">
                                {{ res.status }}
                                <i v-if="res.status === 'Error' || res.status === 'Fail'" class="fa-solid fa-circle-exclamation ml-1 text-xs" :title="res.error"></i>
                            </td>
                            <td class="px-3 py-2 text-right font-mono">{{ res.latency }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div v-if="modal.type === 'login'" class="space-y-4">
                <form @submit.prevent="doLogin">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('username') }}</label>
                        <input type="text" v-model="loginForm.username" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('password') }}</label>
                        <input type="password" v-model="loginForm.password" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition-colors">{{ t('login') }}</button>
                </form>
            </div>

            <template #footer>
                <button v-if="modal.type === 'saved'" @click="reloadPage" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    {{ t('ok') }}
                </button>
                <button v-if="modal.type !== 'saved' && modal.type !== 'saving' && modal.type !== 'testing' && modal.type !== 'login'" @click="modal.show = false" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    {{ t('ok') }}
                </button>
            </template>
        </modal>
    </div>
</div>

<script>
const i18nData = {
    zh: {
        menu_dashboard: "概览仪表盘",
        menu_logs: "实时查询日志",
        menu_settings: "系统配置",
        status_running: "运行中",
        save_apply: "保存并应用",
        saving: "保存中...",
        refresh: "立即刷新",
        search: "搜索",
        disabled: "未启用",
        stats_total_queries: "总查询次数",
        stats_memory: "内存使用",
        stats_uptime: "持续运行",
        stats_ports: "监听端口",
        stats_traffic_distribution: "流量分流比例",
        stats_upstream_perf: "上游服务器性能",
        top_clients: "活跃客户端",
        top_domains: "热点域名",
        logs_title: "最近查询记录",
        filter_logs_placeholder: "搜索 客户端IP / 域名 / 类型 / 状态...",
        log_time: "时间",
        log_client: "客户端",
        log_domain: "请求域名",
        log_type: "类型",
        log_upstream: "分流策略",
        log_answer: "解析结果",
        log_status: "状态",
        log_duration: "耗时",
        no_logs: "暂无查询日志",
        setting_querylog: "日志记录设置",
        setting_listen: "服务监听端口 (仅需填写端口号)",
        setting_bootstrap: "Bootstrap DNS (引导)",
        setting_upstreams: "上游 DNS 服务器",
        setting_log_limit: "日志保留条数 (内存/持久化)",
        setting_save_file: "开启持久化存储 (保存到文件)",
        setting_log_path: "日志文件路径",
        tab_cn: "国内分组 (CN)",
        tab_overseas: "海外分组 (Overseas)",
        address: "服务器地址",
        protocol: "连接协议",
        ecs_ip: "ECS (客户端子网)",
        add: "添加记录",
        add_server: "添加上游服务器",
        test_upstreams: "一键测试所有上游",
        test_results: "上游连通性测试结果",
        testing: "正在测试连通性...",
        saving_title: "正在保存配置",
        saved_title: "保存成功",
        saved_msg: "配置已成功保存并应用，点击确定刷新页面。",
        ok: "确定",
        latency: "延迟",
        status: "状态",
        dns_udp: "DNS UDP",
        dns_tcp: "DNS TCP",
        doh_https: "DoH (HTTPS)",
        dot_tls: "DoT (TLS)",
        doq_quic: "DoQ (QUIC)",
        table_server: "服务器",
        table_group: "分组",
        table_queries: "查询数",
        table_errors: "错误",
        table_canceled: "取消/超时",
        table_avg_time: "平均耗时",
        login: "登录",
        logout: "退出登录",
        username: "用户名",
        password: "密码",
        login_title: "管理员登录",
        login_fail: "登录失败，请检查用户名和密码"
    },
    en: {
        menu_dashboard: "Dashboard",
        menu_logs: "Query Logs",
        menu_settings: "Settings",
        status_running: "Running",
        save_apply: "Save & Apply",
        saving: "Saving...",
        refresh: "Refresh",
        search: "Search",
        disabled: "Disabled",
        stats_total_queries: "Total Queries",
        stats_memory: "Memory",
        stats_uptime: "Uptime",
        stats_ports: "Listening Ports",
        stats_traffic_distribution: "Traffic Split",
        stats_upstream_perf: "Upstream Performance",
        top_clients: "Top Clients",
        top_domains: "Top Domains",
        logs_title: "Query Log",
        filter_logs_placeholder: "Search Client IP / Domain / Type / Status...",
        log_time: "Time",
        log_client: "Client",
        log_domain: "Domain",
        log_type: "Type",
        log_upstream: "Strategy",
        log_answer: "Answer",
        log_status: "Status",
        log_duration: "Duration",
        no_logs: "No logs found",
        setting_querylog: "Query Log",
        setting_listen: "Listening Ports (Port only)",
        setting_bootstrap: "Bootstrap DNS",
        setting_upstreams: "Upstream Servers",
        setting_log_limit: "Log Retention Limit",
        setting_save_file: "Save to File (Persistent)",
        setting_log_path: "Log File Path",
        tab_cn: "Domestic (CN)",
        tab_overseas: "Overseas",
        address: "Address",
        protocol: "Protocol",
        ecs_ip: "ECS IP",
        add: "Add",
        add_server: "Add Server",
        test_upstreams: "Test All Upstreams",
        test_results: "Test Results",
        testing: "Testing Connectivity...",
        saving_title: "Saving Configuration",
        saved_title: "Saved Successfully",
        saved_msg: "Configuration saved and applied. Click OK to refresh.",
        ok: "OK",
        latency: "Latency",
        status: "Status",
        dns_udp: "DNS UDP",
        dns_tcp: "DNS TCP",
        doh_https: "DoH (HTTPS)",
        dot_tls: "DoT (TLS)",
        doq_quic: "DoQ (QUIC)",
        table_server: "Server",
        table_group: "Group",
        table_queries: "Queries",
        table_errors: "Errors",
        table_canceled: "Canceled",
        table_avg_time: "Avg Time",
        login: "Login",
        logout: "Logout",
        username: "Username",
        password: "Password",
        login_title: "Admin Login",
        login_fail: "Login failed, check credentials"
    }
};

const FormInput = {
    props: ['label', 'modelValue', 'placeholder', 'type', 'disabled'],
    emits: ['update:modelValue'],
    template: `
    <div class="w-full">
        <label class="block text-sm font-medium text-gray-700 mb-1.5">{{ label }}</label>
        <input :type="type || 'text'" 
            :value="modelValue" 
            :disabled="disabled"
            @input="$emit('update:modelValue', $event.target.value)"
            class="shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-lg p-2.5 border transition-all disabled:bg-gray-100 disabled:text-gray-500"
            :placeholder="placeholder">
    </div>
    `
};

const ToggleSwitch = {
    props: ['label', 'modelValue', 'disabled'],
    emits: ['update:modelValue'],
    template: `
    <div class="flex items-center justify-between" :class="{'opacity-60': disabled}">
        <span class="text-sm font-medium text-gray-700 mr-3">{{ label }}</span>
        <label class="flex items-center relative" :class="disabled ? 'cursor-not-allowed' : 'cursor-pointer'">
            <input type="checkbox" :checked="modelValue" :disabled="disabled" @change="$emit('update:modelValue', $event.target.checked)" class="toggle-input sr-only"/>
            <div class="toggle-track">
                <div class="toggle-checkbox"></div>
            </div>
        </label>
    </div>
    `
};

const Modal = {
    props: ['show', 'title'],
    emits: ['close'],
    template: `
    <div v-if="show" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" @click="$emit('close')"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">{{ title }}</h3>
                            <div class="mt-4">
                                <slot></slot>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <slot name="footer"></slot>
                </div>
            </div>
        </div>
    </div>
    `
};

const app = Vue.createApp({
    components: {
        'form-input': FormInput,
        'toggle-switch': ToggleSwitch,
        'modal': Modal
    },
    data() {
        return {
            lang: 'zh',
            currentView: 'dashboard',
            upstreamTab: 'cn',
            config: {
                listen: {},
                bootstrap_dns: [],
                upstreams: { cn: [], overseas: [] },
                geo_data: {},
                auto_cert: { domains: [] },
                web_ui: {},
                query_log: { enabled: false, max_history: 5000, save_to_file: false, file: "" }
            },
            stats: {
                upstream_stats: [],
                top_clients: {},
                top_domains: {}
            },
            logs: [],
            logsFilter: "",
            sortKey: "",
            sortOrder: 1,
            loading: false,
            statsTimer: null,
            logsTimer: null,
            
            authEnabled: false,
            isLoggedIn: false,
            loginForm: { username: '', password: '' },
            modal: {
                show: false,
                type: '', 
                title: '',
                testResults: []
            }
        }
    },
    computed: {
        currentUpstreams() {
            return this.upstreamTab === 'cn' ? this.config.upstreams.cn : this.config.upstreams.overseas;
        },
        canEdit() {
            return !this.authEnabled || this.isLoggedIn;
        },
        sortedTopClients() {
            if (!this.stats.top_clients) return [];
            return Object.entries(this.stats.top_clients).sort((a, b) => b[1] - a[1]);
        },
        sortedTopDomains() {
            if (!this.stats.top_domains) return [];
            return Object.entries(this.stats.top_domains).sort((a, b) => b[1] - a[1]);
        },
        sortedLogs() {
            if (!this.sortKey) return this.logs;
            return [...this.logs].sort((a, b) => {
                let valA = a[this.sortKey];
                let valB = b[this.sortKey];
                
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return -1 * this.sortOrder;
                if (valA > valB) return 1 * this.sortOrder;
                return 0;
            });
        }
    },
    methods: {
        t(key) { return i18nData[this.lang][key] || key; },
        toggleLang() { this.lang = this.lang === 'zh' ? 'en' : 'zh'; },
        formatTime(ts) { 
             const d = new Date(ts);
             return d.toLocaleTimeString('zh-CN', { hour12: false }) + "." + d.getMilliseconds().toString().padStart(3, '0');
        },
        formatNumber(num) { return num ? num.toLocaleString() : 0; },
        formatUptime(sec) {
            if (!sec) return "0s";
            const d = Math.floor(sec / 86400);
            const h = Math.floor((sec % 86400) / 3600);
            const m = Math.floor((sec % 3600) / 60);
            let s = "";
            if (d > 0) s += d + "d ";
            if (h > 0) s += h + "h ";
            s += m + "m";
            return s;
        },
        getPercentage(part, total) {
            if (!total) return 0;
            return ((part / total) * 100).toFixed(1);
        },
        getUpstreamClass(u) {
            if(!u) return "bg-gray-100 text-gray-800";
            if(u.includes("CN") || u.includes("Domestic")) return "bg-green-100 text-green-800";
            if(u.includes("Overseas")) return "bg-blue-100 text-blue-800";
            if(u.includes("Hosts")) return "bg-purple-100 text-purple-800";
            if(u.includes("Fail")) return "bg-red-100 text-red-800";
            return "bg-gray-100 text-gray-800";
        },
        getLatencyClass(ms) {
            if(!ms && ms !== 0) return "";
            if(ms < 50) return "text-green-600";
            if(ms < 200) return "text-yellow-600";
            return "text-red-600";
        },
        getTestStatusClass(status) {
            return status === 'OK' ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
        },
        sortBy(key) {
            if (this.sortKey === key) {
                this.sortOrder = -this.sortOrder;
            } else {
                this.sortKey = key;
                this.sortOrder = 1;
            }
        },
        getSortIcon(key) {
            if (this.sortKey !== key) return "fa-sort text-gray-300";
            return this.sortOrder === 1 ? "fa-sort-up active" : "fa-sort-down active";
        },
        showPipeline(p) { return p === 'tcp' || p === 'dot'; },
        showH3(p) { return p === 'doh'; },
        showVerify(p) { return p === 'dot' || p === 'doh' || p === 'doq'; },
        async checkAuth() {
            try {
                const res = await fetch('/api/auth/status');
                const data = await res.json();
                this.authEnabled = data.enabled;
                this.isLoggedIn = data.authenticated;
            } catch(e) { console.error(e); }
        },
        openLogin() {
            this.loginForm = { username: '', password: '' };
            this.modal = { show: true, type: 'login', title: this.t('login_title') };
        },
        async doLogin() {
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.loginForm)
                });
                if(res.ok) {
                    this.modal.show = false;
                    this.isLoggedIn = true;
                    this.loadConfig();
                } else {
                    alert(this.t('login_fail'));
                }
            } catch(e) { console.error(e); }
        },
        async doLogout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                this.isLoggedIn = false;
                window.location.reload();
            } catch(e) { console.error(e); }
        },
        async loadConfig() {
            try {
                const res = await fetch('/api/config');
                if(!res.ok) throw new Error("Failed to load");
                this.config = await res.json();
                if(!this.config.bootstrap_dns) this.config.bootstrap_dns = [];
                if(!this.config.upstreams.cn) this.config.upstreams.cn = [];
                if(!this.config.upstreams.overseas) this.config.upstreams.overseas = [];
                if(!this.config.query_log) this.config.query_log = { enabled: true, max_history: 5000, save_to_file: false, file: "" };
                
                const strip = (p) => p ? p.toString().replace(':', '') : '';
                if(this.config.listen) {
                    this.config.listen.dns_udp = strip(this.config.listen.dns_udp);
                    this.config.listen.dns_tcp = strip(this.config.listen.dns_tcp);
                    this.config.listen.doh = strip(this.config.listen.doh);
                    this.config.listen.dot = strip(this.config.listen.dot);
                    this.config.listen.doq = strip(this.config.listen.doq);
                }
            } catch(e) {
                console.error(e);
            }
        },
        async saveConfig() {
            if (!this.canEdit) return;
            this.loading = true;
            this.modal = { show: true, type: 'saving', title: this.t('saving_title') };
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config)
                });
                if(!res.ok) {
                    if(res.status === 401) {
                        this.modal.show = false;
                        this.openLogin();
                        return;
                    }
                    throw new Error(await res.text());
                }
                this.modal = { show: true, type: 'saved', title: this.t('saved_title') };
            } catch(e) {
                this.modal.show = false;
                alert("Error: " + e.message);
            } finally {
                this.loading = false;
            }
        },
        reloadPage() {
            window.location.reload();
        },
        async testUpstreams() {
            if (!this.canEdit) return;
            this.modal = { show: true, type: 'testing', title: this.t('testing') };
            try {
                const res = await fetch('/api/test-upstreams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config) 
                });
                if(!res.ok) {
                     if(res.status === 401) {
                        this.modal.show = false;
                        this.openLogin();
                        return;
                    }
                    throw new Error(await res.text());
                }
                const results = await res.json();
                this.modal = { show: true, type: 'test', title: this.t('test_results'), testResults: results };
            } catch(e) {
                this.modal.show = false;
                alert("Test Error: " + e.message);
            }
        },
        async fetchLogs() {
            try {
                let url = '/api/logs?limit=100';
                if(this.logsFilter) url += '&q=' + encodeURIComponent(this.logsFilter);
                const res = await fetch(url);
                this.logs = await res.json();
            } catch(e) { console.error(e); }
        },
        async fetchStats() {
            try {
                const res = await fetch('/api/stats');
                this.stats = await res.json();
            } catch(e) { console.error(e); }
        },
        addBootstrap() { this.config.bootstrap_dns.push(""); },
        removeBootstrap(idx) { this.config.bootstrap_dns.splice(idx, 1); },
        addUpstream(type) {
            const empty = { address: "", protocol: "udp", ecs_ip: "", pipeline: false, http3: false, insecure_skip_verify: false };
            if(type === 'cn') this.config.upstreams.cn.push(empty);
            else this.config.upstreams.overseas.push(empty);
        },
        removeUpstream(type, idx) {
            if(confirm("Are you sure you want to delete this upstream?")) {
                if(type === 'cn') this.config.upstreams.cn.splice(idx, 1);
                else this.config.upstreams.overseas.splice(idx, 1);
            }
        }
    },
    mounted() {
        this.checkAuth();
        this.loadConfig();
        this.fetchStats();
        this.statsTimer = setInterval(this.fetchStats, 3000);
        this.logsTimer = setInterval(() => {
            if(this.currentView === 'logs') this.fetchLogs();
        }, 3000);
    },
    unmounted() {
        clearInterval(this.statsTimer);
        clearInterval(this.logsTimer);
    }
});

app.mount('#app');
</script>